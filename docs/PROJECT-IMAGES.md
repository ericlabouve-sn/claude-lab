# Project-Specific Docker Images

Claude Lab can analyze your project directory and automatically create a custom Docker image with all the tools and dependencies your project needs.

## Quick Start

```bash
# Analyze your project
lab image-from-project /path/to/your/project --analyze-only

# Create a custom image for your project
lab image-from-project /path/to/your/project

# Use the custom image in a lab
lab setup my-lab --image claude-lab:your-project-name
```

## What It Does

The `image-from-project` command:

1. **Analyzes** your project directory
2. **Detects** languages, frameworks, and tools
3. **Recommends** an appropriate base template
4. **Generates** a custom Dockerfile
5. **Builds** the Docker image
6. **Tags** it for use with labs

## Project Analysis

The analyzer detects:

### Languages
- Python (pyproject.toml, requirements.txt, setup.py)
- JavaScript/TypeScript (package.json, tsconfig.json)
- Go (go.mod, go.sum)
- Rust (Cargo.toml)
- Java/Kotlin (pom.xml, build.gradle)
- Ruby (Gemfile)

### Package Managers
- Python: pip, poetry, pipenv, uv, hatch
- JavaScript: npm, yarn, pnpm
- Go: go modules
- Rust: cargo
- Ruby: bundler

### Build Tools
- Make (Makefile)
- Docker (Dockerfile, docker-compose.yml)
- Task (Taskfile.yml)

### Kubernetes Tools
- kubectl (for any k8s manifests)
- helm (Chart.yaml)
- kustomize (kustomization.yaml)
- argocd (ArgoCD manifests)
- flux (Flux manifests)

### Frameworks
- Python: FastAPI, Django, Flask, Starlette
- JavaScript: React, Vue, Next.js, Express

### Databases
- PostgreSQL
- MySQL
- MongoDB
- Redis

## Usage

### Basic Analysis

```bash
# Analyze project without building
lab image-from-project ~/projects/my-app --analyze-only
```

Output:
```
ğŸ“Š Analyzing project...

â”Œâ”€ Project Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Category          â”‚ Found           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Languages         â”‚ python          â”‚
â”‚ Package Managers  â”‚ poetry, uv      â”‚
â”‚ Build Tools       â”‚ docker, make    â”‚
â”‚ K8s Tools         â”‚ helm, kubectl   â”‚
â”‚ Frameworks        â”‚ fastapi         â”‚
â”‚ Databases         â”‚ postgresql      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“ Project Files
â”œâ”€â”€ pyproject.toml (2)
â”œâ”€â”€ Dockerfile (1)
â”œâ”€â”€ Chart.yaml (1)
â””â”€â”€ Makefile (1)

Recommended base template: k8s-full
```

### Generate Dockerfile Only

```bash
# Generate Dockerfile without building
lab image-from-project ~/projects/my-app --dry-run
```

This creates `Dockerfile.claude-lab` in your project directory.

### Build Custom Image

```bash
# Build image with auto-detected settings
lab image-from-project ~/projects/my-app

# Build with custom name
lab image-from-project ~/projects/my-app --name my-custom-image

# Build with specific base template
lab image-from-project ~/projects/my-app --base python-dev
```

### Use Custom Base Template

```bash
# Force use of minimal base
lab image-from-project ~/projects/api --base minimal

# Force use of k8s-full base
lab image-from-project ~/projects/infra --base k8s-full
```

## Example: Kepler Platform Project

```bash
# Analyze the Kepler project
lab image-from-project ~/kepler-base/platform-labs-kepler --analyze-only

# Output shows:
# - Python with poetry/uv
# - Helm charts
# - MkDocs for documentation
# - FastAPI framework
# - PostgreSQL database

# Build custom image
lab image-from-project ~/kepler-base/platform-labs-kepler

# Creates: claude-lab:platform-labs-kepler

# Use in a lab
lab setup kepler-dev --image claude-lab:platform-labs-kepler
```

## Generated Dockerfile

The analyzer generates a Dockerfile that:

1. **Starts from appropriate base template**
2. **Installs language-specific tools**
3. **Adds package managers**
4. **Includes framework dependencies**
5. **Sets up database clients**
6. **Configures workspace**

Example generated Dockerfile:

```dockerfile
# Auto-generated Dockerfile for platform-labs-kepler
# Based on template: k8s-full
# Generated by claude-lab

FROM claude-lab:k8s-full

LABEL claude-lab.project="platform-labs-kepler"
LABEL claude-lab.auto-generated="true"

# Python project dependencies
RUN pip install --no-cache-dir \
    pytest \
    black \
    ruff \
    mypy \
    ipython \
    poetry \
    fastapi \
    uvicorn

# Database clients
RUN apt-get update && apt-get install -y postgresql-client

# Set working directory
WORKDIR /workspace

CMD ["/bin/bash"]
```

## Workflow Integration

### Development Workflow

```bash
# 1. Analyze your project
cd ~/projects/my-app
lab image-from-project . --analyze-only

# 2. Build custom image
lab image-from-project .

# 3. Create lab with custom image
lab setup dev --image claude-lab:my-app

# 4. Work in lab
tmux attach -t dev

# 5. Inside lab, all tools are pre-installed!
poetry install  # âœ“ Works
kubectl get pods  # âœ“ Works
helm list  # âœ“ Works
```

### Team Sharing

```bash
# Build image for project
lab image-from-project ~/projects/team-app --name team-app-v1

# Tag for registry
docker tag claude-lab:team-app-v1 registry.company.com/claude-lab:team-app-v1

# Push to registry
docker push registry.company.com/claude-lab:team-app-v1

# Team members use it
lab setup feature --image registry.company.com/claude-lab:team-app-v1
```

### CI/CD Integration

```yaml
# .github/workflows/build-lab-image.yml
name: Build Lab Image

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: astral-sh/setup-uv@v2

      - name: Install claude-lab
        run: uv pip install -e .

      - name: Build project image
        run: lab image-from-project . --name ${{ github.event.repository.name }}

      - name: Push to registry
        run: |
          docker tag claude-lab:${{ github.event.repository.name }} \
            ghcr.io/${{ github.repository }}:latest
          docker push ghcr.io/${{ github.repository }}:latest
```

## Base Template Selection

The analyzer recommends a base template based on your project:

| Project Type | Recommended Base | Why |
|--------------|------------------|-----|
| Python-only | `python-dev` | Python 3.11, pip, uv, pytest |
| K8s manifests | `k8s-full` | kubectl, helm, kustomize, etc. |
| Mixed dev | `base` | General tools |
| Simple scripts | `minimal` | Lightweight |

Override with `--base`:

```bash
lab image-from-project ~/my-project --base k8s-full
```

## Advanced Features

### Custom Image Names

```bash
# Use project directory name (default)
lab image-from-project ~/projects/api
# Creates: claude-lab:api

# Specify custom name
lab image-from-project ~/projects/api --name api-v2
# Creates: claude-lab:api-v2
```

### Iterative Development

```bash
# 1. Initial analysis
lab image-from-project ~/project --analyze-only

# 2. Generate Dockerfile
lab image-from-project ~/project --dry-run

# 3. Edit Dockerfile.claude-lab manually if needed
vim ~/project/Dockerfile.claude-lab

# 4. Build with docker directly
docker build -f ~/project/Dockerfile.claude-lab -t claude-lab:project .

# 5. Or rebuild with lab
lab image-from-project ~/project
```

### Multi-Project Workspace

```bash
# Build images for multiple projects
for project in ~/projects/*; do
    lab image-from-project "$project" --name $(basename "$project")
done

# List all project images
lab image-list
```

## Troubleshooting

### Analysis Fails

```bash
# Check project directory exists
ls -la /path/to/project

# Check for readable files
find /path/to/project -name "*.json" -o -name "*.toml"

# Try with explicit base
lab image-from-project /path/to/project --base base
```

### Build Fails

```bash
# Check generated Dockerfile
lab image-from-project /path/to/project --dry-run
cat /path/to/project/Dockerfile.claude-lab

# Check base image exists
lab image-list | grep k8s-full

# Build base image first
lab image-build k8s-full

# Retry project image
lab image-from-project /path/to/project
```

### Image Too Large

```bash
# Use minimal base
lab image-from-project ~/project --base minimal

# Or edit generated Dockerfile
lab image-from-project ~/project --dry-run
# Edit Dockerfile.claude-lab to remove unnecessary tools
docker build -f Dockerfile.claude-lab -t claude-lab:project .
```

## Best Practices

### 1. Analyze Before Building

Always run analysis first to see what will be included:

```bash
lab image-from-project ~/project --analyze-only
```

### 2. Use Meaningful Names

```bash
# Good - descriptive
lab image-from-project ~/api --name api-backend-v2

# Bad - generic
lab image-from-project ~/api --name test
```

### 3. Version Your Images

```bash
# Build versioned image
lab image-from-project ~/app --name app-v1.0.0

# Update when dependencies change
lab image-from-project ~/app --name app-v1.1.0
```

### 4. Keep Dockerfile

The generated `Dockerfile.claude-lab` is saved to your project:

```bash
# Commit it to version control
git add Dockerfile.claude-lab
git commit -m "Add claude-lab Dockerfile"
```

### 5. Document in README

Add to your project README:

```markdown
## Development with claude-lab

```bash
# Build development image
lab image-from-project . --name myapp-dev

# Create lab environment
lab setup dev --image claude-lab:myapp-dev
```
```

## Integration with Existing Features

### With Lab Setup

```bash
# Build image and create lab in one workflow
lab image-from-project ~/project --name my-project
lab setup dev --image claude-lab:my-project
```

### With Image Management

```bash
# List all images including project images
lab image-list

# Inspect project image
lab image-inspect my-project

# Update project image
lab image-from-project ~/project --name my-project

# Delete old project image
lab image-delete my-project-old
```

### With Cleanup

```bash
# Project images are tracked like any other
lab image-list

# Clean up old project images
docker images | grep claude-lab | grep project
docker rmi claude-lab:old-project
```

## Summary

Project-specific images provide:

âœ… **Automatic detection** of project dependencies
âœ… **Custom Dockerfile generation** tailored to your project
âœ… **Pre-installed tools** for faster lab startup
âœ… **Reproducible environments** across team members
âœ… **Version control** for development environments
âœ… **CI/CD integration** for automated builds

**Quick command:**

```bash
lab image-from-project /path/to/project
```

That's it! Your project now has a custom claude-lab image ready to use.
